# HumanWrites

A writing tool that proves your writing is your own — capturing keystroke dynamics during composition and issuing verifiable Ed25519-signed certificates of human authorship.

---

## Key Features

**Zen Editor**
Distraction-free writing environment built on TipTap v2 and ProseMirror. Paragraph-level focus, light/dark mode, and auto-save to IndexedDB keep your attention on the words.

**Human Written Certification**
Every keystroke event (dwell time, flight time, typing speed variance, pause entropy) is analyzed in a Web Worker and aggregated into a Layer 1 trust score. When a document is complete, the backend issues an Ed25519-signed certificate. Certificates can be verified offline using the public key at `/.well-known/humanwrites-public-key.pem`.

**AI Spelling Assist**
Spell and grammar checking for Korean and English via Claude/OpenAI, streamed over SSE. Suggestions appear as inline underlines in the editor. AI is strictly a proofreading assistant — it never generates or rewrites content.

---

## Tech Stack

### Frontend
| Layer | Technology |
|-------|-----------|
| Framework | Next.js 15 (App Router) |
| Editor | TipTap v2 + ProseMirror |
| State | Zustand (local) + TanStack Query (server) |
| Styling | Tailwind v4 + CSS Variables |
| UI Primitives | Radix UI |
| API Client | orval (auto-generated from OpenAPI) |
| Animation | framer-motion |
| Realtime | STOMP.js over WebSocket |
| Build | Turborepo + pnpm |
| Testing | Vitest + Playwright + MSW + Storybook |

### Backend
| Layer | Technology |
|-------|-----------|
| Framework | Spring Boot 3.4 + Spring MVC + Virtual Threads (Java 21) |
| Language | Kotlin 2.1 |
| ORM | Exposed (JDBC) |
| Auth | Spring Security + OAuth2 (Google) + JWT |
| Database | PostgreSQL 16 + TimescaleDB (keystroke hypertable) |
| Cache | Redis 7 |
| API Docs | SpringDoc OpenAPI |
| Signing | Ed25519 (JDK 21 native) |
| Migration | Flyway |
| Testing | Kotest + MockK + Testcontainers |

---

## Prerequisites

| Requirement | Minimum version |
|-------------|----------------|
| Node.js | 20.x |
| pnpm | 10.x |
| Java | 21 (JDK with Virtual Threads) |
| Docker + Docker Compose | any recent version |

---

## Quick Start

### 1. Start infrastructure

```bash
docker compose -f docker/docker-compose.yml up -d
```

This starts:
- PostgreSQL 16 + TimescaleDB on port `5432`
- Redis 7 on port `6379`

### 2. Configure environment variables

Create `backend/src/main/resources/application-local.yml`:

```yaml
GOOGLE_CLIENT_ID: <your-google-oauth-client-id>
GOOGLE_CLIENT_SECRET: <your-google-oauth-client-secret>
JWT_SECRET: <minimum-256-bit-random-string>
ED25519_PRIVATE_KEY: <base64url-encoded-pem>
OPENAI_API_KEY: <your-openai-api-key>
# or: CLAUDE_API_KEY: <your-claude-api-key>
```

### 3. Start the backend

```bash
cd backend && ./gradlew bootRun
# Listening on http://localhost:8080
```

### 4. Install frontend dependencies and start the dev server

```bash
cd frontend && pnpm install && pnpm dev
# Listening on http://localhost:3000
```

### 5. (Optional) Regenerate the TypeScript API client

Run this after making backend API changes:

```bash
make openapi-generate
```

This starts the backend temporarily, exports `schema/openapi.yaml` via SpringDoc, then runs orval to regenerate `frontend/packages/api-client/`.

---

## Project Structure

```
humanwrites/
├── frontend/                      # Turborepo monorepo
│   ├── apps/web/                  # Next.js 15 app
│   │   ├── app/                   # RSC + Client Components
│   │   └── .well-known/           # humanwrites-public-key.pem
│   └── packages/
│       ├── core/                  # Pure TypeScript — no DOM dependency
│       │   ├── typing-analyzer/   # Keystroke analysis and scoring
│       │   ├── certificate/       # Certificate data structures and validation
│       │   └── scoring/           # Layer 1 trust score calculation
│       ├── ui/                    # Radix-based component library
│       ├── editor-react/          # TipTap wrapper and editor state
│       ├── api-client/            # Auto-generated orval hooks (do not edit)
│       └── realtime/              # STOMP and SSE clients
│
├── backend/                       # Gradle + Kotlin
│   └── src/main/kotlin/com/humanwrites/
│       ├── config/                # Spring configuration
│       ├── domain/                # DDD domains: user, document, session, certificate, ai
│       ├── infrastructure/        # Persistence (Exposed), security, Redis, external APIs
│       └── presentation/          # Controllers, DTOs, WebSocket handlers, SSE
│
├── schema/
│   └── openapi.yaml               # Auto-generated by SpringDoc (source of truth)
│
├── docker/
│   └── docker-compose.yml         # PostgreSQL + TimescaleDB + Redis
│
├── docs/                          # Development phase documents and lessons learned
├── Makefile                       # Unified build orchestration
├── PROJECT_PLAN.md
├── DESIGN_SYSTEM.md
├── TEST_STRATEGY.md
└── UX_STRATEGY.md
```

---

## Development Commands

All top-level commands are available via `make`. Run `make help` to see the full list.

### Development servers

```bash
make dev              # Start infra + frontend + backend together
make dev-frontend     # Frontend dev server only
make dev-backend      # Backend dev server only
```

### Build

```bash
make build            # Build frontend and backend
make build-frontend   # pnpm turbo build
make build-backend    # ./gradlew build -x test
```

### Test

```bash
make test             # Run all tests
make test-frontend    # pnpm turbo test (Vitest + Playwright)
make test-backend     # ./gradlew test (Kotest + Testcontainers)
```

### Lint and type check

```bash
make lint             # ESLint (frontend) + ktlint via Spotless (backend)
make type-check       # tsc --noEmit (frontend) + compileKotlin (backend)
```

### OpenAPI pipeline

```bash
make schema-generate  # Export openapi.yaml from running backend
make client-generate  # Run orval to regenerate api-client package
make openapi-generate # Full pipeline: schema + client
```

### Infrastructure

```bash
make infra-up         # docker compose up -d
make infra-down       # docker compose down
make infra-reset      # docker compose down -v (deletes volumes)
```

### Clean

```bash
make clean            # Remove all build artifacts and node_modules
```

---

## Environment Variables

All sensitive values belong in `backend/src/main/resources/application-local.yml` and must never be committed.

| Variable | Description |
|----------|-------------|
| `GOOGLE_CLIENT_ID` | Google OAuth 2.0 client ID |
| `GOOGLE_CLIENT_SECRET` | Google OAuth 2.0 client secret |
| `JWT_SECRET` | HMAC secret for JWT signing (minimum 256 bits) |
| `ED25519_PRIVATE_KEY` | Base64URL-encoded Ed25519 private key for certificate signing |
| `OPENAI_API_KEY` | OpenAI API key for spelling/grammar checks |
| `CLAUDE_API_KEY` | Anthropic API key (alternative to OpenAI) |

The corresponding Ed25519 public key is served at `/.well-known/humanwrites-public-key.pem` and allows offline certificate verification without contacting the server.

---

## API Overview

| Domain | Method | Endpoint |
|--------|--------|----------|
| Auth | POST | `/api/auth/oauth/{provider}` |
| Auth | POST | `/api/auth/refresh`, `/api/auth/logout` |
| Documents | GET, POST | `/api/documents` |
| Documents | GET, PUT, DELETE | `/api/documents/{id}` |
| Certificates | POST, GET | `/api/certificates` |
| Certificates | DELETE | `/api/certificates/{id}` |
| Verify | GET | `/api/verify/{shortHash}` (public, no auth) |
| AI | POST | `/api/ai/spelling` |
| AI (SSE) | GET | `/api/ai/summary/{documentId}` |
| Users | GET, PUT | `/api/users/settings` |
| Users | POST | `/api/users/export` |
| Users | DELETE | `/api/users` |
| STOMP publish | — | `/app/session.{keystroke,start,end}` |
| STOMP subscribe | — | `/user/queue/session.{status,anomaly}` |

The full OpenAPI specification is available at `http://localhost:8080/swagger-ui.html` when the backend is running.

---

## Quality Gates

Every pull request must pass:

- `tsc --noEmit` — zero TypeScript errors
- `pnpm turbo lint` — zero ESLint errors
- `./gradlew spotlessCheck` — zero ktlint violations
- Frontend unit test coverage >= 80%
- Backend JaCoCo coverage >= 80%
- All Playwright E2E scenarios pass for changed flows

---

## License

License TBD.
